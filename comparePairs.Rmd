---
title: "Pairwise comparison report"
output: pdf_document
---

<!-- Created by Daniel Beck on 7/28/2015 -->
<!-- Modified: -->
<!--      7/30/2015 Continued development. Tested on Human datasets. -->


```{r, echo=FALSE, message=FALSE, warning=FALSE}
setwd("/projects/steelheadSperm/code")
source("dataNames.R")
source("customFunctions.R")
library(pander)
library(bsgenomePackageName, character.only=T, lib.loc=genomeDirectory)
library(VennDiagram)

# this file holds information on specific report variables. it is generated by generateReports.R
load("reportValues.Rdata")

resultsFiles<-c(paste(resultsDirectory, comparisonNames, "/methLists.RData", sep=""))
pvc<-which(pValues==reportPvalue)

resultsList<-list()
dmrNumberList<-list()
for (i in 1:length(comparisonNames)){
     # load results into temporary environment
     temp = local({load(resultsFiles[[i]]); environment()})
     dmrNumberList[[i]]<-temp$dmrNumberTable
     # extract selected DMR list
     resultsList[[i]]<-temp$methList2p[[pvc]]

     rm(temp)
}
# make sure chromosome start and stop are numeric
resultsList<-lapply(resultsList, function(i){
     i$start<-as.numeric(i$start)
     i$stop<-as.numeric(i$stop)
     i
})

s1<-sapply(strsplit(comparisonNames, split="_|-"), function(i) i[2])
s2<-sapply(strsplit(comparisonNames, split="_|-"), function(i) i[3])
s1<-seqFiles$ctFlag[as.numeric(s1)]
s2<-seqFiles$ctFlag[as.numeric(s2)]

comparisonType<-paste(s1, " vs ", s2, sep="")
comparisonType[grep("all", comparisonNames)]<-"all H vs all N"

```

Pairwise MeDIP analysis summary for the `r projectName` project. Report generated `r format(Sys.Date(), format="%B %d %Y")`

### DMR number

```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis"}

summaryTable<-cbind("analysis"=comparisonNames, "comparison"=comparisonType, "p-value"=reportPvalue, "DMR Number"=sapply(resultsList, nrow))
summaryTable<-as.data.frame(summaryTable)
     

pandoc.table(summaryTable, split.tables=Inf, style="rmarkdown", caption=paste("This table shows the p-values and total DMR numbers for each analysis.", sep=""))

```


### DMR overlap

```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=5}
labels<-paste(comparisonType, sapply(strsplit(comparisonNames, split="_"), function(i) i[2]), sep=" ")
labels[1]<-"all H vs all N"
# H vs H
# v1<-vennDMRthree2(resultsList[2:4], names=labels[2:4], scaled=T)
v1<-vennBPfour(resultsList[c(1,2:4)], names=labels[c(1,2:4)])
#**Figure 1.** This figure shows the number of overlapping DMR between the pairwise comparisons of hatchery samples. Overlapping DMR are defined as DMRs that have at least one base pair in common. Each DMR is only counted once, including it in higher order overlaps preferentially. The number of overlapping DMR is then divided by the number of analyses that are included in the overlaping region of the Venn diagram.

```

**Figure 1.** This figure shows the number of overlapping base pairs among the DMR for analyses of all pairs of hatchery samples.


```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=5}
# N vs N
# v2<-vennDMRthree2(resultsList[5:7], names=labels[5:7], scaled=T)
v2<-vennBPfour(resultsList[c(1,5:7)], names=labels[c(1,5:7)])
#**Figure 2.** This figure shows the number of overlapping DMR between the pairwise comparisons of natural samples. Overlapping DMR are defined as DMRs that have at least one base pair in common. Each DMR is only counted once, including it in higher order overlaps preferentially. The number of overlapping DMR is then divided by the number of analyses that are included in the overlaping region of the Venn diagram.

```

**Figure 2.** This figure shows the number of overlapping base pairs among the DMR for analyses of all pairs of natural samples.


```{r, echo=FALSE, message=FALSE, warning=FALSE, results="asis", fig.height=5}
# H vs N - 1
# v3<-vennDMRthree2(resultsList[c(8, 12, 16)], names=labels[c(8, 12, 16)], scaled=T)
v3<-vennBPfour(resultsList[c(1, 8, 12, 16)], names=labels[c(1, 8, 12, 16)])
#**Figure 3.** This figure shows the number of overlapping DMR between the pairwise comparisons of hatchery vs natural samples. Overlapping DMR are defined as DMRs that have at least one base pair in common. Each DMR is only counted once, including it in higher order overlaps preferentially. The number of overlapping DMR is then divided by the number of analyses that are included in the overlaping region of the Venn diagram.

```

**Figure 3.** This figure shows the number of overlapping base pairs among the DMR for a selection of analyses comparing pairs of hatchery and natural samples.


